# 安全

[8大安全问题（上）](https://zhuanlan.zhihu.com/p/30649102)
[8大安全问题（下）](https://www.cnblogs.com/botoo/p/8182236.html)
[安全问题自查](https://zhuanlan.zhihu.com/p/161009640)
## xss - cross-site-scripting - 跨站脚本攻击

1. 前端数据入口没有做处理，如从 url 上取参，评论输入框中取值等入口。
2. 包含有恶意代码的字符串直接存储于后端数据库中，再返回给前端参与渲染。
3. 导致前端渲染出错，将用户信息泄露或是伪造了用户行为进行操作。

常见评论，私信，邮件等富文本场景

### sql 注入

与 xss 类似，都是前端数据入口没有做转义处理。但后端同时也没有一定编码规范，直接使用拼接 sql 的方式执行数据库语句，导致破坏了数据或提升了用户权限等非正常操作。

> 防御

- 对输入做过滤，不相信任何用户输入
- 对 html 做充分转义
- 设置 cookie http-only，防止注入成功后脚本读取 cookie 泄露用户信息
- 验证码，防止脚本冒充用户提交危险操作
- 谨慎使用 .innerHtml .outHtml document.write 等操作

```js
// 过滤一些Html字符
const sensitiveMap = {
    '\n':'\\n',
    '\r':'\\r',
    '\'':"\\'",
    '"':'&quot;',
    "\&":"&amp;",
    "\\":"\\\\",
    "\t":"\\t",
    "\b":"\\b",
    "\f":"\\f",
    "<":"&lt;",
    ">":"&gt;"
}
function safeParse(str){
    return str.split('').map(a => sensitiveMap[a] || a).join('')
}
```

## csrf - cross-site-request-forgery - 跨站请求伪造
> 举例
1. 受害者登录 网站 A，登录后，浏览器并保留了其登录凭证（Cookie）。
2. 攻击者引诱受害者访问了 **B** (比如黄图，邮件诱骗点击等)。
3. **B** 向 **A** 发送了一个请求：A/act=xx。浏览器会默认携带 **A** 的 Cookie。
4. **A** 接收到请求后，对请求进行验证，并确认是受害者的凭证，误以为是受害者自己发送的请求。
5. **A** 以受害者的名义执行了 act=xx。
6. 攻击完成，攻击者在受害者不知情的情况下，冒充受害者，让 A 执行了自己定义的操作。
   攻击者并没有直接接触 cookie 等用户信息，仅仅是冒用

> 实现
- 本质就是欺骗用户点击，执行一段请求，假图片，假新闻骗取点击为伪造请求即可。
- 假设一个论坛送礼物的请求是get的，我们可以插入一个图片元素，以这个请求为地址，若论坛没有做防御，那么所有看到这个图片元素的人都发送了这个请求，且携带了自己的cookie，送出了礼物。
- 对于get请求，很容易伪造，而post请求同样也可以伪造网页欺骗用户点击进入的形式去发送 

> 防御

攻击者不是直接获取到token，而只是诱骗用户点击，浏览器自动带去的。

- 自动防御策略：同源检测（Origin 和 Referer 验证），也就是浏览器的跨域机制，所以后端做cors策略需要详细验证请求的referer 不要什么域名都通过。
- 主动防御措施：Token 验证 或者 双重 Cookie 验证 以及配合 Samesite Cookie。
- 保证页面的幂等性，后端接口不要在 GET 页面中做用户操作。
- 双token机制，服务端在cookie里插入一个token，同时表单请求时插入一个token，接受到请求后后端校验cookie和请求中的token，验证合法性。

## dns 劫持

在网络范围内拦击域名解析的请求，返回假的 ip 地址

> 防御
> 本质是攻击运营商的解析服务器来达到目的，公司可以架设自己的解析服务器，又或者直接以 ip 的形式发送请求，避免劫持

## http 劫持

在运营商的路由节点上设置协议检测，发现 http 请求且是 html 类型，则恶意拦截处理，常见有：

- 类似 dns 劫持返回 302，让用户跳转别的网址。（钓鱼网站）
- 在服务器返回的 html 内插入 js 脚本。（广告）
  > 防御
- 使用 https
- 禁止转码申明
- 在网页中加入安全策略，检测 js 脚本是否在白名单内
- 联系运营商
